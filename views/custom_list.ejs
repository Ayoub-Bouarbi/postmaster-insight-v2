<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Domain List - Postmaster Insights</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .sidebar {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
        }

        .table-row-group:hover {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, rgba(59, 130, 246, 0.02) 100%);
            transition: background 0.2s ease;
        }

        .loader-cell {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loader {
            width: 28px;
            height: 28px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .gradient-border {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6, #06b6d4);
            padding: 2px;
            border-radius: 0.75rem;
        }

        .gradient-border .inner {
            background: rgba(15, 23, 42, 0.9);
            border-radius: calc(0.75rem - 2px);
        }

        .floating-animation {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite alternate;
        }

        @keyframes pulse-glow {
            from { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            to { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
        }

        .metric-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2);
        }

        .domain-link {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            padding: 0.25rem 0.5rem; /* smaller padding to fit */
            border-radius: 0.5rem;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            display: block;            /* occupy full cell width */
            max-width: 100%;
            overflow: hidden;          /* truncate long domains */
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.875rem;       /* text-sm */
        }

        .domain-link:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .search-input {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: rgba(59, 130, 246, 0.6);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border: none;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: rgba(55, 65, 81, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.5);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(75, 85, 99, 0.8);
            transform: translateY(-1px);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table-header {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-bottom: 2px solid rgba(59, 130, 246, 0.2);
        }

        .nav-item {
            position: relative;
            transition: all 0.3s ease;
        }

        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(2px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            color: #3b82f6;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 60%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 2px;
        }

        .data-table {
            border-collapse: separate;
            border-spacing: 0;
            table-layout: fixed;
            width: 100%;
        }

        .data-table th {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
            vertical-align: middle;
        }

        .data-table thead tr:first-child th:first-child {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            width: 200px;
            min-width: 200px;
            max-width: 200px;
        }

        .data-table td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
            vertical-align: middle;
        }

        .data-table td:first-child {
            background: rgba(15, 23, 42, 0.5);
            font-weight: 600;
            width: 200px;
            min-width: 200px;
            max-width: 200px;
        }

        .data-table tr:hover td {
            background: rgba(59, 130, 246, 0.05);
        }

        .data-table tr:hover td:first-child {
            background: rgba(59, 130, 246, 0.1);
        }

        /* Column widths are controlled by <colgroup id="table-colgroup"> to keep header/body perfectly aligned */
        /* Include padding and borders in width calculations for perfect alignment */
        .data-table,
        .data-table th,
        .data-table td {
            box-sizing: border-box;
        }

        .metric-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .spam-value {
            font-weight: 600;
            font-size: 0.875rem;
        }
        /* Fixed chart height to avoid modal vertical growth */
        .fixed-chart-height { height: 256px; }
    </style>
</head>

<body class="text-gray-200">
    <div class="flex min-h-screen">
        <aside class="sidebar w-20 flex flex-col items-center space-y-6 py-6 fixed h-full z-10">
            <a href="/custom" class="text-blue-400 pulse-glow" title="Postmaster Insights">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full blur-lg opacity-30"></div>
                    <div class="relative bg-gradient-to-r from-blue-500 to-purple-600 p-3 rounded-full">
                        <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 9v.906a2.25 2.25 0 01-1.183 1.981l-6.478 3.488M2.25 9v.906a2.25 2.25 0 001.183 1.981l6.478 3.488m8.86-1.981LT18 17.25a2.25 2.25 0 01-2.25 2.25H8.25A2.25 2.25 0 016 17.25l-2.732-1.468m15.464-11.41L12 2.25 2.25 9" />
                        </svg>
                    </div>
                </div>
            </a>
            <nav class="flex flex-col items-center space-y-4 flex-grow">
                <a href="/domain" title="Single Domain" class="nav-item p-3 rounded-lg">
                    <svg class="w-6 h-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
                    </svg>
                </a>
                <a href="/custom" title="Custom List" class="nav-item active p-3 rounded-lg">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" />
                    </svg>
                </a>
            </nav>
            <a href="/logout" title="Logout" class="nav-item p-3 rounded-lg">
                <svg class="w-6 h-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                </svg>
            </a>
        </aside>

        <main class="ml-20 w-full p-6 lg:p-10">
            <div class="mb-8">
                <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-white via-blue-100 to-purple-200 bg-clip-text text-transparent">Custom Domain Watchlist</h1>
                <p class="text-gray-400 text-lg">Monitor multiple domains with comprehensive analytics</p>
                <div class="w-24 h-1 bg-gradient-to-r from-blue-500 to-purple-600 mt-4 rounded-full"></div>
            </div>
            
            <div class="gradient-border mb-8">
                <div class="inner p-6">
                    <form action="/custom" method="POST">
                        <label for="domains-textarea" class="block text-gray-200 font-semibold mb-3 text-lg">Domain List</label>
                        <div class="relative">
                            <textarea id="domains-textarea" name="domains" rows="8"
                                class="search-input appearance-none rounded-xl w-full py-4 px-6 text-gray-200 placeholder-gray-500 focus:outline-none resize-none"
                                placeholder="example.com&#10;example.org&#10;example.net&#10;&#10;Enter one domain per line..."><%= session_domains.join('\n') %></textarea>
                            <div class="absolute top-4 right-4 text-gray-500 text-sm">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-6">
                            <div class="text-sm text-gray-400">
                                <span class="font-medium text-blue-300"><%= session_domains.length %></span> domains configured
                                <span class="ml-3 text-gray-500">Press <span class="text-gray-300 font-semibold">Ctrl/⌘ + Enter</span> to update</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <a href="/custom/clear" class="btn-secondary text-white font-semibold py-2.5 px-6 rounded-xl">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                        Clear List
                                    </span>
                                </a>
                                <button type="submit" class="btn-primary text-white font-semibold py-2.5 px-6 rounded-xl">
                                    <span class="flex items-center">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                                        </svg>
                                        Update List
                                    </span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <% if (session_domains && session_domains.length > 0) { %>

            <div id="summary-stats" class="grid grid-cols-7 gap-4 mb-6 text-white overflow-x-auto">
            </div>

            <div class="glass-card rounded-xl p-6 mb-6">
                <div class="flex flex-col lg:flex-row items-center justify-between space-y-4 lg:space-y-0 lg:space-x-6">
                    <div class="w-full lg:w-1/3">
                        <label class="block text-gray-300 font-medium mb-2">Search Domains</label>
                        <div class="relative">
                            <input type="search" id="domain-search" placeholder="Type to search domains..."
                                class="search-input appearance-none rounded-xl w-full py-3 px-4 pl-12 text-gray-200 placeholder-gray-500 focus:outline-none">
                            <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col lg:flex-row items-center space-y-4 lg:space-y-0 lg:space-x-4 w-full lg:w-auto">
                        <div class="w-full lg:w-80">
                            <label class="block text-gray-300 font-medium mb-2">Date Range</label>
                            <div class="relative">
                                <input type="text" id="date-range-picker" placeholder="Select Date Range..."
                                    class="search-input appearance-none rounded-xl w-full py-3 px-4 pl-12 text-gray-200 placeholder-gray-500 focus:outline-none">
                                <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="w-full lg:w-auto">
                            <label class="block text-gray-300 font-medium mb-2">&nbsp;</label>
                            <button id="filter-button" class="btn-primary text-white font-semibold py-3 px-6 rounded-xl w-full lg:w-auto">
                                <span class="flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                                    </svg>
                                    Apply Filter
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full data-table">
                        <colgroup id="table-colgroup"></colgroup>
                        <thead class="table-header " id="table-header">
                        </thead>
                        <tbody id="domains-table-body" class="divide-y divide-white/10"></tbody>
                    </table>
                </div>
            </div>
            <% } %>
        </main>
    </div>
    <!-- Domain Details Modal -->
    <div id="domain-modal" class="fixed inset-0 z-40 hidden">
        <div id="domain-modal-backdrop" class="absolute inset-0 bg-black/60"></div>
        <div id="domain-modal-wrapper" class="absolute inset-0 flex items-center justify-center p-4">
            <div class="glass-card rounded-xl w-full max-w-6xl max-h-[92vh] overflow-auto p-6 relative">
                <button id="domain-modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <h2 id="domain-modal-title" class="text-2xl font-bold mb-2 text-white"></h2>
                <div class="flex flex-wrap items-center justify-between mb-4 gap-3">
                    <p class="text-gray-400">Detailed graphs and metrics</p>
                    <div class="flex items-center gap-2">
                        <a id="domain-modal-open-page" href="#" class="btn-secondary text-white font-semibold py-2 px-4 rounded-lg">Open full page</a>
                        <button id="domain-modal-export" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg">Export CSV</button>
                    </div>
                </div>
                <div id="domain-modal-badges" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="glass-card rounded-xl p-4 fixed-chart-height">
                        <h3 class="text-sm font-semibold text-gray-300 mb-2">Spam</h3>
                        <canvas id="chart-spam"></canvas>
                    </div>
                    <div class="glass-card rounded-xl p-4 fixed-chart-height">
                        <h3 class="text-sm font-semibold text-gray-300 mb-2">Domain reputation</h3>
                        <canvas id="chart-domain-rep"></canvas>
                    </div>
                    <div class="glass-card rounded-xl p-4 fixed-chart-height">
                        <h3 class="text-sm font-semibold text-gray-300 mb-2">IP reputation</h3>
                        <canvas id="chart-ip-rep"></canvas>
                    </div>
                    <div class="glass-card rounded-xl p-4 fixed-chart-height">
                        <h3 class="text-sm font-semibold text-gray-300 mb-2">Traffic (encrypted/authenticated)</h3>
                        <canvas id="chart-traffic"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
                           <!-- JavaScript code for the table list page -->

    <% if (session_domains && session_domains.length > 0) { %>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        const domains = <%- JSON.stringify(session_domains) %>;
        const tableHeader = document.getElementById('table-header');
        const tableBody = document.getElementById('domains-table-body');
        const filterButton = document.getElementById('filter-button');
        const searchInput = document.getElementById('domain-search');
        const modal = document.getElementById('domain-modal');
        const modalBackdrop = document.getElementById('domain-modal-backdrop');
        const modalClose = document.getElementById('domain-modal-close');
        const modalTitle = document.getElementById('domain-modal-title');

        // Responsive metric column width (pixels)
        let metricColPx = 120;

        const computeMetricWidth = (datesCount) => {
            const tableEl = document.querySelector('table.data-table');
            if (!tableEl) return 120;
            const container = tableEl.parentElement; // immediate wrapper div
            const containerWidth = container ? container.clientWidth : tableEl.clientWidth;
            const totalMetricCols = Math.max(1, datesCount * 3);
            const available = Math.max(0, containerWidth - 200); // subtract domain column
            // Clamp between 60 and 160 for readability
            const px = Math.max(60, Math.min(160, Math.floor(available / totalMetricCols)));
            return px;
        };

        const applyTdWidths = () => {
            document.querySelectorAll('.data-table tbody tr').forEach(tr => {
                Array.from(tr.cells).forEach((td, idx) => {
                    if (idx === 0) return; // domain column
                    td.style.width = metricColPx + 'px';
                    td.style.minWidth = metricColPx + 'px';
                    td.style.maxWidth = metricColPx + 'px';
                });
            });
        };

        const updateHeaderDateGroupWidths = () => {
            const firstRow = tableHeader.querySelector('tr:first-child');
            if (!firstRow) return;
            const ths = Array.from(firstRow.querySelectorAll('th')).slice(1); // skip DOMAIN
            ths.forEach(th => {
                const w = metricColPx * 3;
                th.style.width = w + 'px';
                th.style.minWidth = w + 'px';
                th.style.maxWidth = w + 'px';
            });
        };

        let startDate = moment().subtract(8, 'days').format('YYYY-MM-DD');
        let endDate = moment().subtract(2, 'days').format('YYYY-MM-DD');

        flatpickr("#date-range-picker", {
            mode: "range",
            dateFormat: "Y-m-d",
            defaultDate: [startDate, endDate],
            maxDate: moment().subtract(2, 'days').toDate(),
            onClose: (selectedDates) => {
                if (selectedDates.length === 2) {
                    startDate = moment(selectedDates[0]).format('YYYY-MM-DD');
                    endDate = moment(selectedDates[1]).format('YYYY-MM-DD');
                }
            }
        });

        const getDatesArray = (start, end) => Array.from({
            length: moment(end).diff(moment(start), 'days') + 1
        }, (_, i) => moment(start).add(i, 'days').format('YYYY-MM-DD'));

        const getReputationColor = (rep) => ({
            'HIGH': 'bg-green-500/20 text-green-300',
            'MEDIUM': 'bg-yellow-500/20 text-yellow-300',
            'LOW': 'bg-orange-500/20 text-orange-300',
            'BAD': 'bg-red-500/20 text-red-300'
        } [rep] || 'bg-gray-500/20 text-gray-300');

        const getSpamRateColor = (rate) => {
            if (rate == null) return 'text-gray-200';
            if (rate >= 0.3) return 'text-red-400';
            if (rate >= 0.1) return 'text-yellow-400';
            return 'text-green-400';
        };

        const applyColgroupWidths = (totalDataColumns, metricColPx) => {
            // Apply consistent widths to header and body via <colgroup>
            const colgroup = document.getElementById('table-colgroup');
            if (!colgroup) return;
            let colHtml = '';
            colHtml += '<col style="width:200px; min-width:200px; max-width:200px;">';
            for (let i = 0; i < totalDataColumns; i++) {
                colHtml += '<col style="width:' + metricColPx + 'px; min-width:' + metricColPx + 'px; max-width:' + metricColPx + 'px;">';
            }
            colgroup.innerHTML = colHtml;
        };

        const renderTableSkeleton = (dates) => {
            const totalDataColumns = dates.length * 3;
            metricColPx = computeMetricWidth(dates.length);
            applyColgroupWidths(totalDataColumns, metricColPx);
            
            // Create proper two-row header structure that matches data columns exactly
            let headerHtml = '';
            
            // First row: Domain column + Date columns with colspan
            headerHtml += '<tr>';
            headerHtml += '<th rowspan="2" class="px-4 py-4 text-left text-sm font-semibold text-gray-300 uppercase tracking-wider">DOMAIN</th>';
            
            dates.forEach(date => {
                const groupWidth = metricColPx * 3;
                headerHtml += `<th colspan="3" style="width:${groupWidth}px;min-width:${groupWidth}px;max-width:${groupWidth}px" class="px-2 py-4 text-center text-sm font-semibold text-gray-300 uppercase tracking-wider">${moment(date).format('D MMM').toUpperCase()}</th>`;
            });
            headerHtml += '</tr>';
            
            // Second row: Metric labels - must match exact column structure
            headerHtml += '<tr>';
            dates.forEach(() => {
                headerHtml +=
                    '<th class="px-2 py-3 text-center text-xs font-medium text-gray-400">' +
                        '<div class="flex items-center justify-center">' +
                            '<span class="text-red-400 mr-1">▲</span>' +
                            'Spam' +
                        '</div>' +
                    '</th>' +
                    '<th class="px-2 py-3 text-center text-xs font-medium text-gray-400">' +
                        '<div class="flex items-center justify-center">' +
                            '<span class="text-green-400 mr-1">◎</span>' +
                            'Dom' +
                        '</div>' +
                    '</th>' +
                    '<th class="px-2 py-3 text-center text-xs font-medium text-gray-400">' +
                        '<div class="flex items-center justify-center">' +
                            '<span class="text-purple-400 mr-1">✦</span>' +
                            'IP' +
                        '</div>' +
                    '</th>';
            });
            headerHtml += '</tr>';
            
            tableHeader.innerHTML = headerHtml;

            // Create table body with domains as rows
            tableBody.innerHTML = '';
            domains.forEach(domain => {
                // Create exactly the same number of cells as header columns
                let dataCells = '';
                dates.forEach(() => {
                    dataCells += 
                        '<td class="px-2 py-4 text-center" style="width:' + metricColPx + 'px;min-width:' + metricColPx + 'px;max-width:' + metricColPx + 'px">' +
                            '<div class="loader-cell"><div class="loader"></div></div>' +
                        '</td>' +
                        '<td class="px-2 py-4 text-center" style="width:' + metricColPx + 'px;min-width:' + metricColPx + 'px;max-width:' + metricColPx + 'px">' +
                            '<div class="loader-cell"><div class="loader"></div></div>' +
                        '</td>' +
                        '<td class="px-2 py-4 text-center" style="width:' + metricColPx + 'px;min-width:' + metricColPx + 'px;max-width:' + metricColPx + 'px">' +
                            '<div class="loader-cell"><div class="loader"></div></div>' +
                        '</td>';
                });
                
                tableBody.innerHTML += `
                    <tr class="table-row-group" data-domain="${domain}">
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-200">
                            <button type="button" data-open-domain="${domain}" class="domain-link inline-block px-3 py-2 rounded-lg bg-gray-800/50 border border-gray-600/30 hover:bg-gray-700/50 transition-colors">${domain}</button>
                        </td>
                        ${dataCells}
                    </tr>`;
            });
            updateHeaderDateGroupWidths();
        };

        const renderDomainData = (domainData, dates) => {
            const domain = domainData.domain;
            const row = document.querySelector(`tr[data-domain="${domain}"]`);
            if (!row) return;

            // Create exactly the same number of cells as header columns
            let dataCells = '';
            dates.forEach(date => {
                const daily = domainData.daily_stats[date] || {};
                const spam = daily.user_reported_spam_rate;
                const domainRep = daily.overall_reputation || 'NONE';
                const ipRep = daily.true_ip_reputation || 'NONE';

                const spamColorClass = getSpamRateColor(spam);
                const spamValue = spam != null ? `${spam.toFixed(1)}%` : '-';
                
                const domainRepDisplay = domainRep === 'NONE' ? '-' : 
                    `<span class="metric-badge ${getReputationColor(domainRep)}">${domainRep}</span>`;
                
                const ipRepDisplay = ipRep === 'NONE' ? '-' : 
                    `<span class="metric-badge ${getReputationColor(ipRep)}">${ipRep}</span>`;

                dataCells += 
                    '<td class="px-2 py-4 text-center" style="width:' + metricColPx + 'px;min-width:' + metricColPx + 'px;max-width:' + metricColPx + 'px">' +
                        `<span class="spam-value ${spamColorClass} text-sm font-medium">${spamValue}</span>` +
                    '</td>' +
                    '<td class="px-2 py-4 text-center" style="width:' + metricColPx + 'px;min-width:' + metricColPx + 'px;max-width:' + metricColPx + 'px">' +
                        `<div class="text-sm">${domainRepDisplay}</div>` +
                    '</td>' +
                    '<td class="px-2 py-4 text-center" style="width:' + metricColPx + 'px;min-width:' + metricColPx + 'px;max-width:' + metricColPx + 'px">' +
                        `<div class="text-sm">${ipRepDisplay}</div>` +
                    '</td>';
            });

            // Update the row with new data cells
            const domainCell = row.cells[0].outerHTML;
            row.innerHTML = domainCell + dataCells;
        };
        
        const calculateAndRenderSummaryStats = (allDomainData, dates) => {
             if (!dates || dates.length === 0) {
                document.getElementById('summary-stats').innerHTML = '';
                return;
            }

            // Find the latest date in range that has any usable data across domains
            let summaryDay = null;
            for (let i = dates.length - 1; i >= 0 && !summaryDay; i--) {
                const d = dates[i];
                const anyData = allDomainData.some(dd => {
                    const daily = dd.daily_stats && dd.daily_stats[d];
                    return daily && (daily.user_reported_spam_rate != null || daily.overall_reputation || daily.true_ip_reputation);
                });
                if (anyData) summaryDay = d;
            }

            if (!summaryDay) {
                document.getElementById('summary-stats').innerHTML = `
                    <div class="metric-card rounded-xl p-6 text-center col-span-6">
                        <p class="text-gray-300">No data available for the selected range.</p>
                    </div>
                `;
                return;
            }

            const totalDomains = allDomainData.length;
            let spamPositiveCount = 0;
            let spamZeroCount = 0;
            let spamNoDataCount = 0;
            const domainCounts = { HIGH: 0, MEDIUM: 0, LOW: 0, BAD: 0 };
            const ipCounts = { HIGH: 0, MEDIUM: 0, LOW: 0, BAD: 0 };
            let spamSum = 0;
            let spamN = 0;

            for (const domainData of allDomainData) {
                const daily = domainData.daily_stats[summaryDay];

                if (!daily || daily.user_reported_spam_rate == null) {
                    spamNoDataCount++;
                } else if (daily.user_reported_spam_rate > 0) {
                    spamPositiveCount++;
                    spamSum += daily.user_reported_spam_rate <= 1 ? daily.user_reported_spam_rate * 100 : daily.user_reported_spam_rate;
                    spamN++;
                } else { 
                    spamZeroCount++;
                    spamSum += 0;
                    spamN++;
                }

                const domainRep = daily ? daily.overall_reputation : null;
                if (domainRep && domainRep !== 'NONE') {
                    if (domainCounts.hasOwnProperty(domainRep)) domainCounts[domainRep]++;
                }

                const ipRep = daily ? daily.true_ip_reputation : null;
                if (ipRep && ipRep !== 'NONE') {
                    if (ipCounts.hasOwnProperty(ipRep)) ipCounts[ipRep]++;
                }
            }

            const avgSpam = spamN > 0 ? (spamSum / spamN) : null;
            const dayLabel = moment(summaryDay).format('D MMM').toUpperCase();
            
            const statsContainer = document.getElementById('summary-stats');
            statsContainer.innerHTML = `
                <div class="metric-card rounded-xl p-6 text-center">
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-6 h-6 text-blue-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        <p class="text-sm font-semibold text-gray-300">Total Domains</p>
                    </div>
                    <p class="text-3xl font-bold text-white">${totalDomains}</p>
                </div>
                <div class="metric-card rounded-xl p-6 text-center">
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-6 h-6 text-red-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <p class="text-sm font-semibold text-gray-300">Average Spam (${dayLabel})</p>
                    </div>
                    <p class="text-3xl font-bold ${avgSpam == null ? 'text-gray-400' : (avgSpam >= 30 ? 'text-red-400' : avgSpam >= 10 ? 'text-yellow-400' : 'text-green-400')}">${avgSpam == null ? '-' : avgSpam.toFixed(1) + '%'}</p>
                </div>
                <div class="metric-card rounded-xl p-6 text-center">
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-6 h-6 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-sm font-semibold text-gray-300">Domain Rep</p>
                    </div>
                    <div class="flex justify-center items-baseline space-x-3 mt-2">
                        <div class="text-center">
                            <p class="text-lg font-bold text-green-400">${domainCounts.HIGH}</p>
                            <p class="text-xs text-gray-400">HIGH</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-yellow-400">${domainCounts.MEDIUM}</p>
                            <p class="text-xs text-gray-400">MED</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-orange-400">${domainCounts.LOW}</p>
                            <p class="text-xs text-gray-400">LOW</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-red-400">${domainCounts.BAD}</p>
                            <p class="text-xs text-gray-400">BAD</p>
                        </div>
                    </div>
                </div>
                <div class="metric-card rounded-xl p-6 text-center">
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-6 h-6 text-purple-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <p class="text-sm font-semibold text-gray-300">IP Rep</p>
                    </div>
                    <div class="flex justify-center items-baseline space-x-3 mt-2">
                        <div class="text-center">
                            <p class="text-lg font-bold text-green-400">${ipCounts.HIGH}</p>
                            <p class="text-xs text-gray-400">HIGH</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-yellow-400">${ipCounts.MEDIUM}</p>
                            <p class="text-xs text-gray-400">MED</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-orange-400">${ipCounts.LOW}</p>
                            <p class="text-xs text-gray-400">LOW</p>
                        </div>
                        <div class="text-center">
                            <p class="text-lg font-bold text-red-400">${ipCounts.BAD}</p>
                            <p class="text-xs text-gray-400">BAD</p>
                        </div>
                    </div>
                </div>
                <div class="metric-card rounded-xl p-6 text-center">
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-6 h-6 text-red-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <p class="text-sm font-semibold text-gray-300">Spam > 0% (${dayLabel})</p>
                    </div>
                    <p class="text-3xl font-bold text-red-400">${spamPositiveCount}</p>
                </div>
                <div class="metric-card rounded-xl p-6 text-center">
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-6 h-6 text-green-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-sm font-semibold text-gray-300">Spam = 0% (${dayLabel})</p>
                    </div>
                    <p class="text-3xl font-bold text-green-400">${spamZeroCount}</p>
                </div>
                <div class="metric-card rounded-xl p-6 text-center">
                    <div class="flex items-center justify-center mb-2">
                        <svg class="w-6 h-6 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-sm font-semibold text-gray-300">No Data (${dayLabel})</p>
                    </div>
                    <p class="text-3xl font-bold text-gray-400">${spamNoDataCount}</p>
                </div>
            `;
        };

        const fetchAllData = async () => {
            const dates = getDatesArray(startDate, endDate);
            renderTableSkeleton(dates);
            document.getElementById('summary-stats').innerHTML = '';

            const allDomainData = [];
            const promises = domains.map(async (domain) => {
                try {
                    const response = await fetch(
                        `/api/custom_domain_data/${domain}?start_date=${startDate}&end_date=${endDate}`
                        );
                    if (!response.ok) throw new Error(`API error for ${domain}`);

                    const data = await response.json();
                    allDomainData.push(data);
                    renderDomainData(data, dates);
                } catch (error) {
                    console.error(`Failed to fetch data for ${domain}:`, error);
                }
            });

            await Promise.all(promises);
            calculateAndRenderSummaryStats(allDomainData, dates);
        };

        const handleSearch = () => {
            const searchTerm = searchInput.value.toLowerCase();
            document.querySelectorAll('tr[data-domain]').forEach(row => {
                const domain = row.dataset.domain.toLowerCase();
                row.style.display = domain.includes(searchTerm) ? '' : 'none';
            });
        };

        filterButton.addEventListener('click', fetchAllData);
        searchInput.addEventListener('input', handleSearch);
        document.addEventListener('DOMContentLoaded', fetchAllData);

        // Keep alignment on resize
        const debounced = (fn, wait = 150) => {
            let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
        };
        window.addEventListener('resize', debounced(() => {
            const headerDates = Array.from(tableHeader.querySelectorAll('tr:nth-child(1) th')).length - 1; // minus DOMAIN
            if (headerDates > 0) {
                const totalDataColumns = headerDates * 3;
                metricColPx = computeMetricWidth(headerDates);
                applyColgroupWidths(totalDataColumns, metricColPx);
                updateHeaderDateGroupWidths();
                applyTdWidths();
            }
        }, 200));

        // --- Modal logic ---
        let chartInstances = [];
        let lastSeries = null;

        const disposeCharts = () => {
            chartInstances.forEach(c => c.destroy());
            chartInstances = [];
        };

        const openModal = () => {
            modal.classList.remove('hidden');
            setTimeout(() => {
                // focus trap optional; keep simple
            }, 0);
        };

        const closeModal = () => {
            disposeCharts();
            modal.classList.add('hidden');
        };

        modalBackdrop.addEventListener('click', closeModal);
        // Close when clicking outside the card (wrapper) but not on the card itself
        const modalWrapper = document.getElementById('domain-modal-wrapper');
        modalWrapper.addEventListener('click', (e) => {
            const card = e.target.closest('.glass-card');
            if (!card) closeModal();
        });
        modalClose.addEventListener('click', closeModal);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

        const reputationToScore = (rep) => {
            if (!rep) return null;
            const map = { HIGH: 3, MEDIUM: 2, LOW: 1, BAD: 0 };
            return map[rep] ?? null;
        };

        const fetchDomainSeries = async (domain) => {
            const dates = getDatesArray(startDate, endDate);
            const res = await fetch(`/api/custom_domain_data/${domain}?start_date=${startDate}&end_date=${endDate}`);
            if (!res.ok) throw new Error('Failed to load domain');
            const data = await res.json();
            const labels = dates.map(d => moment(d).format('D MMM'));

            const spamSeries = [];
            const domainRepSeries = [];
            const ipRepSeries = [];
            const encryptedTraffic = [];
            const authenticatedTraffic = [];

            let lastDailyWithAnyData = null;
            let lastIndexWithAnyData = -1;
            dates.forEach((d, idx) => {
                const daily = (data.daily_stats && data.daily_stats[d]) || {};
                // Convert spam to percentage if backend sends 0..1 or 0..100; show as % consistently
                let spam = daily.user_reported_spam_rate;
                if (spam == null) {
                    spamSeries.push(null);
                } else {
                    if (spam <= 1) spam = spam * 100; // assume ratio
                    spamSeries.push(spam);
                }
                domainRepSeries.push(reputationToScore(daily.overall_reputation));
                ipRepSeries.push(reputationToScore(daily.true_ip_reputation));
                encryptedTraffic.push(daily.encrypted_traffic_percentage ?? null);
                authenticatedTraffic.push(daily.authenticated_traffic_percentage ?? null);
                if (spam != null || daily.overall_reputation || daily.true_ip_reputation || daily.encrypted_traffic_percentage != null || daily.authenticated_traffic_percentage != null) {
                    lastDailyWithAnyData = daily;
                    lastIndexWithAnyData = idx;
                }
            });

            return { labels, spamSeries, domainRepSeries, ipRepSeries, encryptedTraffic, authenticatedTraffic, lastDailyWithAnyData, lastIndexWithAnyData };
        };

        const renderCharts = (series) => {
            lastSeries = series;
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { ticks: { color: '#9CA3AF' }, grid: { color: 'rgba(255,255,255,0.05)' } }
                },
                plugins: { legend: { labels: { color: '#E5E7EB' } } }
            };

            const ctxSpam = document.getElementById('chart-spam').getContext('2d');
            chartInstances.push(new Chart(ctxSpam, {
                type: 'line',
                data: { labels: series.labels, datasets: [{ label: 'Spam %', data: series.spamSeries, borderColor: '#f87171', backgroundColor: 'rgba(248,113,113,0.2)', spanGaps: true }] },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, suggestedMin: 0, suggestedMax: 100 } } }
            }));

            const ctxDom = document.getElementById('chart-domain-rep').getContext('2d');
            chartInstances.push(new Chart(ctxDom, {
                type: 'line',
                data: { labels: series.labels, datasets: [{ label: 'Domain Rep (0-3)', data: series.domainRepSeries, borderColor: '#34d399', backgroundColor: 'rgba(52,211,153,0.2)', spanGaps: true }] },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, min: 0, max: 3, ticks: { stepSize: 1 } } } }
            }));

            const ctxIp = document.getElementById('chart-ip-rep').getContext('2d');
            chartInstances.push(new Chart(ctxIp, {
                type: 'line',
                data: { labels: series.labels, datasets: [{ label: 'IP Rep (0-3)', data: series.ipRepSeries, borderColor: '#a78bfa', backgroundColor: 'rgba(167,139,250,0.2)', spanGaps: true }] },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, min: 0, max: 3, ticks: { stepSize: 1 } } } }
            }));

            const trafficEl = document.getElementById('chart-traffic');
            const trafficCard = trafficEl.closest('.glass-card');
            const hasTraffic = series.encryptedTraffic.some(v => v != null) || series.authenticatedTraffic.some(v => v != null);
            if (hasTraffic) {
                const ctxTraffic = trafficEl.getContext('2d');
                chartInstances.push(new Chart(ctxTraffic, {
                type: 'line',
                data: { labels: series.labels, datasets: [
                    { label: 'Encrypted %', data: series.encryptedTraffic, borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.2)', spanGaps: true },
                    { label: 'Authenticated %', data: series.authenticatedTraffic, borderColor: '#fbbf24', backgroundColor: 'rgba(251,191,36,0.2)', spanGaps: true }
                ] },
                    options: { ...commonOptions, scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, suggestedMin: 0, suggestedMax: 100 } } }
                }));
                trafficCard.classList.remove('hidden');
            } else {
                // Hide card if no traffic series
                trafficCard.classList.add('hidden');
            }
        };

        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('[data-open-domain]');
            if (!btn) return;
            const domain = btn.getAttribute('data-open-domain');
            try {
                modalTitle.textContent = domain;
                const openPage = document.getElementById('domain-modal-open-page');
                openPage.href = `/domain?name=${encodeURIComponent(domain)}`;
                openModal();
                const series = await fetchDomainSeries(domain);
                // Badges
                const badges = document.getElementById('domain-modal-badges');
                const idxLast = series.lastIndexWithAnyData >= 0 ? series.lastIndexWithAnyData : series.labels.length - 1;
                const spamLast = series.spamSeries[idxLast] == null ? '-' : `${series.spamSeries[idxLast].toFixed(1)}%`;
                const repScore = (v) => v == null ? '-' : v;
                const repLabelFromScore = (v) => ({ 3: 'HIGH', 2: 'MEDIUM', 1: 'LOW', 0: 'BAD' }[v] || '-');
                const domainRepLast = repLabelFromScore(series.domainRepSeries[idxLast]);
                const ipRepLast = repLabelFromScore(series.ipRepSeries[idxLast]);
                const trafficFilled = (series.encryptedTraffic.filter(v=>v!=null).length + series.authenticatedTraffic.filter(v=>v!=null).length) > 0 ? 'Yes' : 'No';
                const lastDateLabel = series.labels[idxLast] || '';
                badges.innerHTML = `
                    <div class="metric-card rounded-lg px-4 py-3 text-center">
                        <p class="text-xs text-gray-400">Spam (${lastDateLabel})</p>
                        <p class="text-lg font-semibold text-white">${spamLast}</p>
                    </div>
                    <div class="metric-card rounded-lg px-4 py-3 text-center">
                        <p class="text-xs text-gray-400">Domain Rep</p>
                        <p class="text-lg font-semibold text-white">${domainRepLast}</p>
                    </div>
                    <div class="metric-card rounded-lg px-4 py-3 text-center">
                        <p class="text-xs text-gray-400">IP Rep</p>
                        <p class="text-lg font-semibold text-white">${ipRepLast}</p>
                    </div>
                    <div class="metric-card rounded-lg px-4 py-3 text-center">
                        <p class="text-xs text-gray-400">Traffic filled</p>
                        <p class="text-lg font-semibold text-white">${trafficFilled}</p>
                    </div>
                `;
                renderCharts(series);
            } catch (err) {
                console.error(err);
            }
        });

        // Export CSV from lastSeries
        document.getElementById('domain-modal-export').addEventListener('click', () => {
            if (!lastSeries) return;
            const rows = [['Date','Spam %','Domain Rep (0-3)','IP Rep (0-3)','Encrypted %','Authenticated %']];
            for (let i = 0; i < lastSeries.labels.length; i++) {
                rows.push([
                    lastSeries.labels[i],
                    lastSeries.spamSeries[i] ?? '',
                    lastSeries.domainRepSeries[i] ?? '',
                    lastSeries.ipRepSeries[i] ?? '',
                    lastSeries.encryptedTraffic[i] ?? '',
                    lastSeries.authenticatedTraffic[i] ?? ''
                ]);
            }
            const csv = rows.map(r => r.map(v => `${v}`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${modalTitle.textContent}_metrics.csv`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Submit domain list with Ctrl/Cmd + Enter
        const domainsTextarea = document.getElementById('domains-textarea');
        const updateForm = domainsTextarea ? domainsTextarea.closest('form') : null;
        if (domainsTextarea && updateForm) {
            domainsTextarea.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    updateForm.submit();
                }
            });
        }
    </script>
    <% } %>
</body>

</html>
